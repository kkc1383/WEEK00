<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>오늘의 기록</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <style>
    #timer-display {
      font-size: 80px;
      font-weight: bold;
      text-align: center;
    }
    .btn-timer {
      font-size: 20px;
      width: 120px;
      margin: 10px;
    }
  </style>
  <link rel="stylesheet" href="../static/CSS/application.css">
</head>
<body class="text-center" data-sleeping="{{'true' if is_sleeping else 'false'}}">
          <div class="user-bar">
                  <img src="../static/images/compassicon.jpg" alt="로고" width="30" height="30" />
                  <div class="user-name">{{ user_name }}님 환영합니다</div>
          <button type="button" class="btn-logout" onclick="logout()">로그아웃</button>
        </div>
  <div id="wrap">
    <div class="wrapper">
      <section class="timer-wrapper">
        <h1 class="logo">
          <img src="../static/images/logo.svg" alt="로고" width="300" height="300">
        </h1>
          <div id="status-message">
          {% if is_sleeping %}  <!-- 수면 중일 때 -->
            <h2>휴식을 종료할까요?</h2>
            <h3>좋은 아침입니다! 오늘 하루도 화이팅!</h3>
          {% else %}            <!-- 수면 중이 아닐 때 -->
            <h2>휴식을 시작할까요?</h2>
            <h3>오늘 하루도 고생하셨습니다!</h3>
          {% endif %}
        </div>
        <div id="timer-display">00:00:00</div>
        <div class="timer-btn-group">
          <button class="timer-btn start" onclick="openObjectiveTimer()">시작</button>
          <button class="timer-btn stop" onclick="openWakePopup()">종료</button>
        </div>
      </section><!-- timer-wrapper -->
      <section class="objective-timer-wrapper">
        <div class="timer-label objective_time">
          <!--  목표 기상시간 설정 <span class="arrow">&#9660;</span> -->
          </div>
          <div class="objective_timer">
            <label for="targetTime">목표 기상시간</label>
            <input type="time" id="targetTime" name="targetTime">
            <button class="close-btn" onclick="closeObjectiveTimer()">확인</button>
          </div>
      </section><!-- objective-timer-wrapper -->
      <section class="user-list-wrapper">
        <div class="user-list" id="user-list">
          {% for name, duration in users.items() %}
            <div class="user-card">
              <div class="status-box {{'on' if duration !='00:00' else 'off'}}">상태박스</div>
              <div class="inner-text">
                <div class="user-name">{{ name }}</div>
                <div class="user-timer">{{duration}}</div>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="category-bar">
            <button class="category-btn disabled">오늘의 기록</button>
            <a href="{{ url_for('calender') }}" class="category-btn">이달의 기록</a>
        </div>
      </section><!--user-list-wrapper-->
    </div>
  </div>
  <!-- 목표 수면 팝업 -->
<div class="custom-popup" id="sleep-popup" style="display:none;">
  <div class="popup-content">
    <p class="popup-title">주무시겠어요?</p>
    {% if isExistYesterday %}
      <p class="popup-diff">
        어제보다 <span class="highlight">{{ sleeptime_diff }}</span> 더 
        <span class="highlight">{{ sleep_trend }}</span> 주무시네요.
      </p>
      <p class="popup-avg">
        최근 3일간 그룹 평균 취침시간은 <span class="highlight">{{ groupsleep_avg }}</span> 입니다.
      </p>
    {% else %}
      <p class="popup-diff">
        비교할 어제의 기록이 없어요.
      </p>
      <p class="popup-avg">
        최근 3일간 그룹 평균 취침시간은 <span class="highlight">{{ groupsleep_avg }}</span> 입니다.
      </p>
    {% endif %}
    <div class="popup-btn-group">
      <button class="yes-btn" onclick="onSleepConfirm()">네</button>
      <button class="no-btn" onclick="closeSleepPopup()">아니오</button>
    </div>
  </div>
</div>
<div class="custom-popup" id="wake-popup" style="display:none;">
  <div class="popup-content">
    <p class="popup-title">휴식을 종료하시겠어요?</p>
    {% if isExistYesterday %}
      <p class="popup-diff">
        어제보다 <span class="highlight">{{ waketime_diff }}</span> 더 
        <span class="highlight">{{ wake_trend }}</span> 일어나셨네요.
      </p>
      <p class="popup-avg">
        최근 3일간 그룹 평균 기상시간은 <span class="highlight">{{ groupwake_avg }}</span> 입니다.
      </p>
    {% else %}
      <p class="popup-diff">
        어제는 기록하지 않으셨네요!
      </p>
      <p class="popup-avg">
        최근 3일간 그룹 평균 기상시간은 <span class="highlight">{{ groupwake_avg }}</span> 입니다.
      </p>
    {% endif %}
    <div class="popup-btn-group">
      <button class="yes-btn" onclick="onWakeConfirm()">네</button>
      <button class="no-btn" onclick="closeWakePopup()">아니오</button>
    </div>
  </div>
</div>
  
  <!--
   초 단위로 변환해야됨
   시작을 누르면 디비로 id 이름 날짜 수면시작시간 저장
   종료를 누르면 디비로 수면종료시간 총 수면시간 저장
  -->

  <!-- jQuery 로드 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    let seconds = 0;
    let timer = null;
    let startTime = null;
    let totalStartTime = null; // totalStartTime 변수 정의
    let inputValue = null;
    let wakeup_goal=null;
    let isSleeping=document.body.dataset.sleeping==='true';
    // 사용자 정보 변수 정의 (Django 템플릿 변수 사용)
    const userId = "{{ user_id|default('guest') }}";
    const userName = "{{ user_name|default('게스트') }}";
    
    function onGoingTimer(){
      if ({{ is_sleeping | tojson }}){
          seconds={{ elapsed_seconds}};
          updateTimerDisplay();
          timer=setInterval(() => {
            seconds++;
            updateTimerDisplay();
          },1000);
      }
    }
    onGoingTimer();
    function logout() {
      $.post("/logout", function () {
        alert('로그아웃 성공!')
        window.location.href='/'
      }).fail(function () {
        alert("로그아웃 중 오류가 발생했습니다.");
      });
    }

    function tryRefreshAndRetry(callback){
      $.post('/refresh',{}, function (res){
        if (res.result==='success'){
          localStorage.setItem('access_token',res.access_token);
          callback();
        }else{
          alert('세션이 만료되었습니다. 다시 로그인해주세요.');
          window.location.href='/';
        }
      });
    }

    function formatTime(totalSeconds) {
      const hrs = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const mins = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const secs = String(totalSeconds % 60).padStart(2, '0');
      return `${hrs}:${mins}:${secs}`;
    }

    function updateTimerDisplay() {
      const totalSeconds = seconds;
      document.getElementById('timer-display').innerText = formatTime(totalSeconds);
    }

    function openObjectiveTimer() {
      if(isSleeping) return;
      document.querySelector('.objective_time').classList.add('on');
      document.querySelector('.objective_timer').style.display = 'block';
    }

    function closeObjectiveTimer() {
      wakeup_goal = document.getElementById('targetTime').value;

      if (!wakeup_goal) {
        alert('목표 수면 시간 설정 실패! 다시 설정 해주세요~!');
        return;
      }

      document.querySelector('.objective_time').classList.remove('on');
      document.querySelector('.objective_timer').style.display = 'none';
      openSleepPopup();
    }

    function openSleepPopup() {
      document.getElementById('sleep-popup').style.display = 'flex';
    }

    function closeSleepPopup() {
      document.getElementById('sleep-popup').style.display = 'none';
    }
    function onSleepConfirm(){
      closeSleepPopup();
      startTimer();
      setTimeout(refreshStatusMessage,500);
    }
    function openWakePopup() {
      if(!isSleeping) return;
      document.getElementById('wake-popup').style.display = 'flex';
    }

    function closeWakePopup() {
      document.getElementById('wake-popup').style.display = 'none';
    }
    function onWakeConfirm(){
      closeWakePopup();
      stopTimer();
      setTimeout(refreshStatusMessage,500);
    }
    function refreshStatusMessage(){
      $.post('/application/status',{
        user_id:userId,
        user_name:userName
      }, function(html){
        $('#status-message').html(html);
        isSleeping=document.body.dataset.sleeping==='true';
      });
    }
    function startTimer() {
      totalStartTime = new Date();
      const date = totalStartTime.getDate();
      const month = totalStartTime.getMonth() + 1;
      const year = totalStartTime.getFullYear();
      const day = `${year}-${month}-${date}`;
      const hour = totalStartTime.getHours();
      const minute = totalStartTime.getMinutes();
      const startTime = `${hour}:${minute}`;

      if (timer) return; // 이미 동작 중이면 무시
      seconds = 0;
      timer = setInterval(() => {
        seconds++;
        updateTimerDisplay();
      }, 1000);
      $.ajax({ // 시작버튼을 누르면 사용자아이디 및 사용자이름과 시작시간과 날짜를 디비에 저장
        type: "POST",
        url: "/application/start",
        data: {
          'id_give': userId, // 사용자아이디
          'name_give': userName, // 사용자이름
          'wakeup_goal_receive': wakeup_goal // 목표 기상시간
        },
        success: function (response) {
          if (response['result'] === 'success') {
            refreshStatusMessage();
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX 오류:', error);
          alert('요청 중 오류가 발생했습니다.');
        }
      });
    }

    function stopTimer() {
      if (!timer) return;
      clearInterval(timer);
      timer = null;

      const totalEndTime = new Date(); // 종료시간 데이터

      let endTime = totalEndTime.getHours() + ':' + totalEndTime.getMinutes();
      console.log(endTime); // 종료시간(시:분)

      const totalSeconds = seconds;
      const minutes = Math.floor(totalSeconds / 60);
      const remainingSeconds = totalSeconds % 60;
      const totalTakeTime = totalEndTime - totalStartTime; // 총 소요시간(밀리초)


      function convertMillisecondsToTime(milliseconds) {
        // 밀리초를 초로 변환
        const totalSeconds = Math.floor(milliseconds / 1000);
        
        // 시와 분 계산
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        
        // 2자리로 포맷팅
        
        const formattedHours = String(hours).padStart(2, '0');
        const formattedMinutes = String(minutes).padStart(2, '0');
        
        return `${formattedHours}:${formattedMinutes}`;
      }

      const timeInHoursMinutes = convertMillisecondsToTime(totalTakeTime);
      console.log(timeInHoursMinutes); // post 보내야하는 총 소요시간(시:분)

      $.ajax({ // 종료버튼을 누르면 종료시간과 총 소요시간을 디비에 저장
        type: "POST",
        url: "/application/end",
        data: {
          'id_give': userId,
          'name_give': userName,
        },
        success: function (response) {
          if (response['result'] === 'success') {
            refreshStatusMessage();
            //alert('성공');
          } else {
            alert('실패!');
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX 오류:', error);
          alert('요청 중 오류가 발생했습니다.');
        }
      });
    }

    function resetTimer() {
      clearInterval(timer);
      seconds = 0;
      console.log(formatTime(seconds)); // 00:00:00
    }

    function refreshUserList() {
      $.post('/application/refresh', {'user_id': userId}, function (res) {
        if (res.result === 'success') {
          const userList = $('#user-list');
          userList.empty();
          for (const [name, duration] of Object.entries(res.users)) {
            const statusClass = duration !== '00:00' ? 'on' : 'off';
            const card = `
              <div class="user-card">
                <div class="status-box ${statusClass}">상태박스</div>
                <div class="inner-text">
                  <div class="user-name">${name}</div>
                  <div class="user-timer">${duration}</div>
                </div>
              </div>
            `;
            userList.append(card);
          }
        } else {
          console.warn('Refresh 실패:', res);
        }
      }).fail(function () {
        console.error('AJAX 요청 실패!');
      });
    }

    // 초기 실행 + 반복 실행
    refreshUserList();
    setInterval(refreshUserList, 60000);
  </script>
</body>
</html>
