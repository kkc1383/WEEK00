<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>타이머</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="../static/CSS/application.css">
</head>
<body class="text-center">
  <!-- 타이머 표시 -->
  <div id="timer-display">00:00:00</div>
  <!-- 타이머 버튼 그룹 -->
  <div class="timer-btn-group">
    <button class="timer-btn start" onclick="startTimer()">시작</button>
    <button class="timer-btn stop" onclick="stopTimer()">종료</button>
  </div>
  <!-- 목표 기상시간 설정 -->
  <div class="timer-label objective_time" onclick="openObjectiveTimer()">
    목표 기상시간 설정 <span class="arrow">&#9660;</span>
  </div>
  <!-- 목표 기상시간 입력 팝업 -->
  <div class="objective_timer">
    <label for="targetTime">목표 기상시간</label>
    <input type="time" id="targetTime" name="targetTime">
    <button class="close-btn" onclick="closeObjectiveTimer()">닫기</button>
  </div>

  <!-- jQuery 로드 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // ===================== 전역 변수 =====================
    let seconds = 0;
    let timer = null;
    let totalStartTime = null;
    let wakeup_goal_receive = null; // 목표 기상시간 저장

    // Django 템플릿에서 사용자 정보 전달
    const userId = "{{ user_id|default('guest') }}";
    const userName = "{{ user_name|default('게스트') }}";

    // ===================== 타이머 표시 함수 =====================
    function formatTime(totalSeconds) {
      const hrs = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
      const mins = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
      const secs = String(totalSeconds % 60).padStart(2, '0');
      return `${hrs}:${mins}:${secs}`;
    }

    function updateTimerDisplay() {
      document.getElementById('timer-display').innerText = formatTime(seconds);
    }

    // ===================== 타이머 시작 =====================
    function startTimer() {
      totalStartTime = new Date();
      const date = totalStartTime.getDate();
      const month = totalStartTime.getMonth() + 1;
      const year = totalStartTime.getFullYear();
      const day = `${year}-${month}-${date}`;
      const hour = totalStartTime.getHours();
      const minute = totalStartTime.getMinutes();
      const startTime = `${hour}:${minute}`;

      if (timer) return; // 이미 동작 중이면 무시
      seconds = 0;
      updateTimerDisplay();
      timer = setInterval(() => {
        seconds++;
        updateTimerDisplay();
      }, 1000);

      // 시작 정보 서버로 전송
      $.ajax({
        type: "POST",
        url: "/application/post",
        data: {
          user_id: userId,
          user_name: userName,
          start_day: day,
          start_time: startTime,
        },
        success: function (response) {
          if (response['result'] === 'success') {
            alert('성공');
          } else {
            alert('실패!');
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX 오류:', error);
          alert('요청 중 오류가 발생했습니다.');
        }
      });
    }

    // ===================== 타이머 종료 =====================
    function stopTimer() {
      if (!timer) return;
      clearInterval(timer);
      timer = null;

      const totalEndTime = new Date();
      const endTime = `${totalEndTime.getHours()}:${totalEndTime.getMinutes()}`;
      const totalSeconds = seconds;

      // 종료 정보 서버로 전송
      $.ajax({
        type: "POST",
        url: "/application/end",
        data: {
          id_give: userId,
          name_give: userName,
        },
        success: function (response) {
          if (response['result'] === 'success') {
            alert('성공');
          } else {
            alert('실패!');
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX 오류:', error);
          alert('요청 중 오류가 발생했습니다.');
        }
      });
    }

    // ===================== 목표 기상시간 팝업 열기/닫기 =====================
    function openObjectiveTimer() {
      document.querySelector('.objective_time').classList.add('on');
      document.querySelector('.objective_timer').style.display = 'flex';
    }
    function closeObjectiveTimer() {
      // input 값 저장
      const inputValue = document.getElementById('targetTime').value;
      wakeup_goal_receive = inputValue;
      console.log('설정된 목표 기상시간:', wakeup_goal_receive);
      document.querySelector('.objective_time').classList.remove('on');
      document.querySelector('.objective_timer').style.display = 'none';
    }
  </script>
</body>
</html>
